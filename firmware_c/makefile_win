# Makefile for ty71m firmware on windows
inputfiles = main.c nuc123_startup.s syscalls.c


objpath:=.\obj

cc:=arm-none-eabi-gcc.exe
ccInclude:=-I.\inc
ccFlags:=-g -ffreestanding --specs=nosys.specs -Wall -Wextra -mcpu=cortex-m0 -mthumb -mfloat-abi=soft
ccSources:=$(filter %.c,$(inputfiles))
ccObj:= $(ccSources:.c=.o)

as:=arm-none-eabi-as.exe
asFlags:=-mcpu=cortex-m0 -mthumb -mfloat-abi=soft
asSources:=$(filter %.s,$(inputfiles))
asObj:=$(asSources:.s=.o) 

ld:=arm-none-eabi-gcc.exe
ldFlags:=-nostdlib -T.\nuc123.ld
outputpath=.\out

objcp  :=arm-none-eabi-objcopy.exe
AllObj :=$(asObj) $(ccObj)


firmwareOUT:=$(outputpath)\firmware.bin

elfFile:=$(outputpath)\firmware.elf


all: $(firmwareOUT)

#Make .o out of .c files, $@ is the target .o file, $< the first dependence so the coresponding .c file
$(ccObj): %.o: %.c
	@echo "Compiling------------------"
	$(cc) $(ccFlags) $(ccInclude) -o $@ $<
	
#Make .o out of .s files, $@ is the target .o file, $< the first dependence so the coresponding .s file
$(asObj): %.o: %.s
	@echo "Assembling-----------------"
	$(as) $(asInFiles) -o $@ $<

$(elfFile): $(AllObj)
	@echo "Linking--------------------"
	$(ld) $(ldFlags) -o $@ $^ -Wl,-Map=memory.map

$(firmwareOUT): $(elfFile)
	@echo "Objcopy--------------------"
	$(objcp) -O binary $(elfFile) $(firmwareOUT)
	

clean:
	@echo "Delete old bin file"
	del /F /Q $(firmwareOUT)